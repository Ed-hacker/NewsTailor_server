================================================================================
                           TNP 프로젝트 API 명세서
================================================================================

1. 기본 정보
   - Base URL: http://localhost:8080
   - Content-Type: application/json
   - 인증 방식: JWT Bearer Token (일부 API)
   - AWS RDS: newstailor-db.cdig6yawukx5.ap-northeast-2.rds.amazonaws.com

================================================================================
                           네이버 뉴스 랭킹 API
================================================================================

⚠️ 중요: 랭킹 뉴스는 북마크 불가능 (요약 뉴스만 북마크 가능)

1. 랭킹 뉴스 조회 (Gemini 요약 포함)
   GET /api/v1/news/ranking

   설명:
   - 모든 카테고리에서 rank 낮은 순으로 최근 24시간 내 20개 반환
   - 각 섹션의 1위 뉴스들을 모아서 표시 (핫한 뉴스 TOP 20)
   - 크롤링 소스: https://news.naver.com/main/ranking/popularDay.naver
   - Gemini AI가 자동으로 생성한 요약 포함
   - 하루 3번 (08:00, 13:00, 20:00) 자동 갱신

   Example: GET /api/v1/news/ranking

   Response:
   [
     {
       "id": 12,
       "sectionId": 100,
       "press": "연합뉴스",
       "rank": 1,
       "title": "정치 1위 기사",
       "url": "https://news.naver.com/...",
       "body": "기사 본문 전체...",
       "summary": "Gemini가 생성한 3문장 이내 요약입니다. 핵심 내용 1. 핵심 내용 2. 핵심 내용 3.",
       "collectedAt": "2025-10-31T15:05:00"
     },
     {
       "id": 45,
       "sectionId": 101,
       "press": "한국경제",
       "rank": 1,
       "title": "경제 1위 기사",
       "url": "https://news.naver.com/...",
       "body": "기사 본문 전체...",
       "summary": "Gemini가 생성한 3문장 이내 요약입니다. 경제 동향 분석. 시장 전망.",
       "collectedAt": "2025-10-31T15:05:00"
     },
     ...
     (총 20개)
   ]

================================================================================
                        요약 뉴스 API (캐시 기반)
================================================================================

1. 사용자 맞춤 요약 뉴스 조회 (페이징)
   GET /api/v1/summary-news?page={0-3}

   Headers:
   - Authorization: Bearer {JWT_TOKEN} (필수)

   Query Parameters:
   - page: 페이지 번호 (0~3, 기본값: 0)

   설명:
   - 사용자가 선택한 3개 관심사별로 Gemini AI가 선별한 4개씩 = 총 12개
   - 각 페이지당 3개 (각 카테고리 1개씩)
   - page 0: 각 카테고리의 1번째 뉴스 3개
   - page 1: 각 카테고리의 2번째 뉴스 3개
   - page 2: 각 카테고리의 3번째 뉴스 3개
   - page 3: 각 카테고리의 4번째 뉴스 3개
   - 캐시 기반: DB에서 조회 (실시간 생성 아님)
   - 크롤링 소스: https://news.naver.com/section/{sectionId}

   Example: GET /api/v1/summary-news?page=0

   Response:
   [
     {
       "sectionId": 100,
       "sectionName": "정치",
       "title": "정치 카테고리 핵심 뉴스 1",
       "url": "https://news.naver.com/...",
       "summary": "Gemini AI가 생성한 3문장 이내 요약 내용입니다. 주요 포인트 1. 주요 포인트 2. 주요 포인트 3."
     },
     {
       "sectionId": 101,
       "sectionName": "경제",
       "title": "경제 카테고리 핵심 뉴스 1",
       "url": "https://news.naver.com/...",
       "summary": "Gemini AI가 생성한 3문장 이내 요약 내용입니다. 경제 동향 분석. 시장 전망."
     },
     {
       "sectionId": 105,
       "sectionName": "IT/과학",
       "title": "IT 카테고리 핵심 뉴스 1",
       "url": "https://news.naver.com/...",
       "summary": "Gemini AI가 생성한 3문장 이내 요약 내용입니다. 기술 혁신. 미래 전망."
     }
   ]

   에러 응답:
   - 400 Bad Request: 페이지 범위 초과 (0~3만 허용)
   - 400 Bad Request: 관심사가 3개로 설정되지 않음
   - 401 Unauthorized: 인증 토큰 없음
   - 503 Service Unavailable: 캐시된 요약 뉴스가 아직 준비되지 않음

================================================================================
                              테스트 API
================================================================================

1. Gemini 연결 테스트 (단일 섹션)
   GET /api/test/gemini?sectionId={100-105}

   설명:
   - 특정 섹션의 최신 뉴스 크롤링
   - Gemini로 4개 선별 및 요약
   - 결과 즉시 반환 (DB 저장 안 함)

   Example: GET /api/test/gemini?sectionId=104

   Response:
   [
     {
       "sectionId": 104,
       "sectionName": "세계",
       "title": "세계 뉴스 제목",
       "url": "https://news.naver.com/...",
       "summary": "Gemini가 생성한 요약..."
     },
     ... (4개)
   ]

2. 전체 섹션 생성 테스트
   POST /api/test/generate-all

   설명:
   - 6개 섹션 모두 크롤링
   - Gemini로 각 섹션당 4개씩 선별/요약
   - DB에 캐시 저장
   - 스케줄러가 실행하는 것과 동일

   Response:
   "전체 섹션 요약 뉴스 생성 완료"

================================================================================
                              인증 API
================================================================================

1. 회원가입
   POST /api/signup

   Request Body:
   {
     "username": "testuser",
     "password": "password123!",
     "nickname": "홍길동",
     "interestIds": [100, 101, 102]
   }

   Validation Rules:
   - username: 4~20자, 필수
   - password: 8~20자, 영문+숫자+특수문자 각 1개 이상, 필수
   - nickname: 2~10자, 필수
   - interestIds: 관심사 ID 배열 (100~105), 선택사항 (회원가입 시)
     * 100: 정치, 101: 경제, 102: 사회, 103: 생활/문화, 104: 세계, 105: IT/과학

   Response:
   201 Created
   "회원가입 성공"

2. 로그인
   POST /api/login

   Request Body:
   {
     "username": "testuser",
     "password": "password123!"
   }

   Response:
   {
     "accessToken": "eyJhbGciOiJIUzI1NiJ9...",
     "username": "testuser"
   }

3. 아이디 중복 체크
   GET /api/auth/check-username?username={username}

   Query Parameters:
   - username: 체크할 사용자명 (4~20자)

   Response:
   {
     "available": true,
     "message": "사용 가능한 아이디입니다."
   }

   또는

   {
     "available": false,
     "message": "이미 사용 중인 아이디입니다."
   }

================================================================================
                              사용자 API
================================================================================

1. 사용자 정보 조회
   GET /api/user/info

   Headers:
   - Authorization: Bearer {JWT_TOKEN}

   설명:
   - 로그인한 사용자의 정보 조회
   - username, nickname, 관심분야 목록 반환

   Response:
   {
     "username": "testuser",
     "nickname": "홍길동",
     "interests": ["정치", "경제", "IT/과학"]
   }

   에러 응답:
   - 401 Unauthorized: 인증 토큰 없음
   - 404 Not Found: 사용자를 찾을 수 없음

2. 프로필 수정
   PUT /api/user/profile

   Headers:
   - Authorization: Bearer {JWT_TOKEN}

   Request Body:
   {
     "nickname": "새로운닉네임",
     "interestIds": [100, 102, 105]
   }

   Validation Rules:
   - nickname: 2~20자, 필수
   - interestIds: 관심사 ID 배열 (100~105), 정확히 3개 필수

   Response:
   200 OK
   "프로필이 수정되었습니다."

   에러 응답:
   - 400 Bad Request: validation 오류 (닉네임 길이, 관심사 개수 등)
   - 401 Unauthorized: 인증 토큰 없음

================================================================================
                              관심사 API
================================================================================

1. 사용 가능한 관심사 목록 조회
   GET /api/interests

   Response:
   [
     {
       "id": 100,
       "name": "정치"
     },
     {
       "id": 101,
       "name": "경제"
     },
     {
       "id": 102,
       "name": "사회"
     },
     {
       "id": 103,
       "name": "생활/문화"
     },
     {
       "id": 104,
       "name": "세계"
     },
     {
       "id": 105,
       "name": "IT/과학"
     }
   ]

2. 사용자 관심사 설정
   POST /api/user/interests

   Headers:
   - Authorization: Bearer {JWT_TOKEN}

   Request Body:
   {
     "interestIds": [100, 101, 105]
   }

   ⚠️ 중요: 정확히 3개의 관심사만 선택 가능

   Validation:
   - interestIds는 null이 아니어야 함
   - 정확히 3개의 ID만 허용 (3개 미만 또는 초과 시 400 에러)
   - ID는 100~105 범위 내 유효한 관심사 ID여야 함

   성공 응답:
   200 OK
   "관심사 등록 성공"

   에러 응답:
   400 Bad Request
   {
     "status": 400,
     "message": "관심사는 정확히 3개를 선택해야 합니다."
   }

================================================================================
                              북마크 API
================================================================================

⚠️ 중요: 북마크는 요약 뉴스(SummaryNewsCache)만 가능합니다.
         랭킹 뉴스(News)는 북마크할 수 없습니다.
         사용자당 최대 50개까지 북마크 가능합니다.

1. 북마크 추가
   POST /api/bookmark?summaryNewsCacheId={id}

   Headers:
   - Authorization: Bearer {JWT_TOKEN}

   Query Parameters:
   - summaryNewsCacheId: 요약 뉴스 캐시 ID (필수)

   설명:
   - 요약 뉴스를 북마크에 추가
   - 북마크 시 뉴스 정보(제목, URL, 요약 등)를 복사해서 저장
   - 스케줄러가 캐시를 삭제해도 북마크는 유지됨
   - 이미 북마크된 뉴스일 경우 에러 반환
   - 사용자당 최대 50개 제한

   Response:
   200 OK
   "북마크가 추가되었습니다."

   에러 응답:
   - 400 Bad Request: 이미 북마크된 뉴스 또는 최대 50개 초과
   - 401 Unauthorized: 인증 토큰 없음
   - 404 Not Found: 요약 뉴스를 찾을 수 없음

2. 북마크 삭제
   DELETE /api/bookmark?summaryNewsCacheId={id}

   Headers:
   - Authorization: Bearer {JWT_TOKEN}

   Query Parameters:
   - summaryNewsCacheId: 요약 뉴스 캐시 ID (필수)

   Response:
   200 OK
   "북마크가 삭제되었습니다."

   에러 응답:
   - 401 Unauthorized: 인증 토큰 없음
   - 404 Not Found: 요약 뉴스를 찾을 수 없음

3. 북마크 목록 조회
   GET /api/bookmark

   Headers:
   - Authorization: Bearer {JWT_TOKEN}

   설명:
   - 현재 사용자가 북마크한 모든 요약 뉴스 조회
   - 북마크된 시간 역순(최신순)으로 반환
   - 캐시가 삭제되어도 북마크는 계속 유지됨
   - 최대 50개까지 조회 가능

   Response:
   [
     {
       "id": 123,
       "sectionId": 100,
       "sectionName": "정치",
       "title": "정치 뉴스 제목",
       "url": "https://news.naver.com/...",
       "summary": "Gemini가 생성한 요약 내용..."
     },
     {
       "id": 456,
       "sectionId": 101,
       "sectionName": "경제",
       "title": "경제 뉴스 제목",
       "url": "https://news.naver.com/...",
       "summary": "Gemini가 생성한 요약 내용..."
     }
   ]

   에러 응답:
   - 401 Unauthorized: 인증 토큰 없음

================================================================================
                           에러 응답 형식
================================================================================

HTTP Status Code와 함께 다음 형식의 에러 응답이 반환됩니다:

{
  "timestamp": "2025-10-31T15:30:00.123+09:00",
  "status": 404,
  "error": "Not Found",
  "message": "뉴스를 찾을 수 없습니다: 999",
  "path": "/api/news/999"
}

주요 에러 코드:
- 400 Bad Request: 잘못된 요청 파라미터, Validation 오류
  * 예시: "관심사는 정확히 3개를 선택해야 합니다."
  * 예시: "아이디는 4~20자 사이여야 합니다., 비밀번호는 영문, 숫자, 특수문자를 각각 최소 1개씩 포함해야 합니다."
- 401 Unauthorized: 인증 토큰이 없거나 유효하지 않음
- 403 Forbidden: 권한 부족
- 404 Not Found: 리소스를 찾을 수 없음
- 500 Internal Server Error: 서버 내부 오류
- 503 Service Unavailable: 서비스 일시적 이용 불가 (예: 캐시 생성 중)

Validation 에러 응답 예시:
{
  "status": 400,
  "message": "비밀번호는 8~20자 사이여야 합니다., 비밀번호는 영문, 숫자, 특수문자를 각각 최소 1개씩 포함해야 합니다."
}

================================================================================
                            크롤링 스케줄
================================================================================

통합 스케줄러 (SummaryNewsScheduler):
- 실행 주기: 하루 3번 (08:00, 13:00, 20:00)
- 실행 내용:
  1. 랭킹 뉴스 크롤링 (https://news.naver.com/main/ranking/popularDay.naver)
     - 모든 섹션 (정치, 경제, 사회, 생활/문화, 세계, IT/과학)
     - URL 기준 중복 방지
     - 본문 내용 수집
     - Gemini AI로 각 기사 요약 생성 (3문장 이내)
     - news_rankings 테이블 저장

  2. 요약 뉴스 생성 (https://news.naver.com/section/{sectionId})
     - 각 섹션별 최신 뉴스 크롤링 (최대 100개)
     - Gemini AI로 중요한 4개 선별 + 요약
     - summary_news_cache 테이블 저장
     - 이전 캐시 삭제 (북마크된 뉴스는 보존)

Gemini API 호출 최적화:
- 기존: 사용자 요청마다 실시간 생성 (100명 × 3 관심사 = 300번 호출/일)
- 개선: 하루 3번 사전 생성 (6 섹션 × 3회 = 18번 호출/일)
- 절감률: 약 94%

데이터 보관 정책:
- news_rankings: 최근 2일치만 유지
- summary_news_cache: 최신 12개만 유지 (하루 3번 갱신)
- bookmark: 사용자당 최대 50개, 무기한 보관
- 크롤링 시작 전 자동으로 오래된 데이터 삭제
- 북마크된 뉴스 정보는 bookmark 테이블에 복사되어 영구 보존
- 예상 데이터량: 약 150~200 MB (2일치 랭킹 + 캐시 + 북마크)

================================================================================
                            데이터베이스
================================================================================

AWS RDS (MySQL):
- Endpoint: newstailor-db.cdig6yawukx5.ap-northeast-2.rds.amazonaws.com
- Database: newstailor_db
- Region: ap-northeast-2 (서울)
- 접근 제한: EC2에서만 접근 가능 (보안 그룹 설정)

주요 테이블:
1. users: 사용자 정보 (username, password, nickname)
2. news: 기존 뉴스 데이터
3. news_rankings: 네이버 뉴스 랭킹 데이터 (2일치만 보관)
   - 크롤링 소스: https://news.naver.com/main/ranking/popularDay.naver
   - 컬럼: id, section_id, press, rank, title, url, body, summary, collected_at
   - Gemini AI가 생성한 요약(summary) 포함
   - 인덱스: section_id, rank, collected_at
4. summary_news_cache: 요약 뉴스 캐시
   - 크롤링 소스: https://news.naver.com/section/{sectionId}
   - 컬럼: id, section_id, section_name, title, url, summary, rank_order, generated_at
   - 인덱스: section_id, rank_order, generated_at
   - 하루 3번 갱신 (섹션당 4개씩, 총 24개 유지)
5. interests: 관심사 정보 (ID: 100~105)
6. user_interest: 사용자-관심사 연결 (정확히 3개)
7. article_like: 뉴스 좋아요
8. bookmark: 요약 뉴스 북마크
   - 컬럼: id, user_id, section_id, section_name, title, url, summary, created_at
   - 뉴스 정보를 직접 저장 (캐시 삭제와 무관하게 보존)
   - ⚠️ 중요: 랭킹 뉴스(news)는 북마크 불가, 요약 뉴스만 가능
   - 사용자당 최대 50개 제한
   - URL 기준 중복 방지
9. summary: 뉴스 요약 (Gemini API 연동)

변경사항:
- users 테이블에서 email 필드 완전 제거
- 사용자 식별은 username으로만 처리
- 회원가입 시 관심사 동시 설정 가능
- 관심사는 정확히 3개만 허용
- TTS 관련 테이블 및 API 제거 (프론트엔드에서 구현)
- H2 Database 제거 (AWS RDS MySQL만 사용)
- summary_news_cache 테이블 추가 (캐시 기반 요약 뉴스)
- bookmark 테이블 대폭 수정:
  * summary_news_cache 참조 제거
  * 뉴스 정보를 직접 저장 (title, url, summary 등)
  * 사용자당 최대 50개 제한
  * URL 기준 중복 방지
  * 캐시 삭제와 무관하게 영구 보존
- 사용자 정보 조회 API 추가 (GET /api/user/info)
- 프로필 수정 API 추가 (PUT /api/user/profile)
- 북마크 API 추가 (요약 뉴스만 북마크 가능)
- 랭킹 뉴스 북마크 기능 비활성화
- news_rankings 테이블에 summary 컬럼 추가 (Gemini 요약)
- 랭킹 뉴스 API 단순화: 글로벌 TOP 20만 제공 (요약 포함)
- 기존 NewsController 제거 (불필요한 API 정리)


================================================================================
                              AI 요약 기능
================================================================================

Gemini API 사용:
- 모델: gemini-1.5-flash
- API URL: https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent
- 개별 뉴스 요약: 3문장 이내 (랭킹 뉴스)
- 배치 선별 요약: 카테고리별 많은 뉴스 중 중요한 4개 선별 + 각각 3문장 요약 (요약 뉴스)

랭킹 뉴스 요약 프로세스:
1. 스케줄러가 하루 3번 (08:00, 13:00, 20:00) 자동 실행
2. 네이버 랭킹 페이지 크롤링 (https://news.naver.com/main/ranking/popularDay.naver)
3. 각 기사 본문 크롤링
4. Gemini API로 각 기사 개별 요약 생성 (3문장 이내)
5. news_rankings 테이블에 저장 (본문 + 요약)
6. 사용자 요청 시 DB에서 조회하여 글로벌 TOP 20 반환

요약 뉴스 생성 프로세스 (캐시 기반):
1. 스케줄러가 하루 3번 (08:00, 13:00, 20:00) 자동 실행
2. 각 섹션별 최신 뉴스 크롤링 (https://news.naver.com/section/{sectionId})
3. Gemini API에 뉴스 목록 전달 (섹션당 최대 100개)
4. Gemini가 각 카테고리당 중요한 4개 선택 + 요약
5. summary_news_cache 테이블에 저장 (section_id, rank_order 1~4)
6. 사용자 요청 시 캐시에서 조회 (실시간 생성 없음)
7. 총 12개 요약 뉴스 반환 (3개 관심사 × 4개)
8. 페이징: 4페이지 (각 페이지 3개)

데이터 소스 분리:
- 랭킹 뉴스: https://news.naver.com/main/ranking/popularDay.naver
  → 본문 크롤링 → Gemini 요약 → news_rankings 테이블 → 글로벌 TOP 20 API
- 요약 뉴스: https://news.naver.com/section/{sectionId}
  → Gemini 선별/요약 → summary_news_cache 테이블 → 사용자 맞춤 요약 API

================================================================================
                            테스트 계정
================================================================================

테스트 사용자:
- Username: testuser1
- Password: password123!
- 관심사: 정치(100), 경제(101), IT/과학(105)

사용 예시:
1. 로그인: POST /api/login
2. 사용자 정보 조회: GET /api/user/info
3. 프로필 수정: PUT /api/user/profile
4. 관심사 설정: POST /api/user/interests (3개 필수)
5. 랭킹 뉴스: GET /api/v1/news/ranking
6. 요약 뉴스 조회: GET /api/v1/summary-news?page=0
7. 북마크 추가: POST /api/bookmark?summaryNewsCacheId=123
8. 북마크 목록: GET /api/bookmark

테스트 엔드포인트:
1. Gemini 연결 테스트: GET /api/test/gemini?sectionId=104
2. 전체 생성 테스트: POST /api/test/generate-all

================================================================================
